--- admin/am_edit	2002/06/14 08:54:33	1.327
+++ admin/am_edit	2002/07/05 11:01:32
@@ -672,10 +672,14 @@ sub tag_FINAL()
             print STDOUT "found ( in $program\_SOURCES. skipping\n" if ($verbose);
             next;
         }
-        
-        my $mocsources = "";
+
+        my $mocs = "";       # Moc files (in this program)
+	my $moc_cpp_added = 0;  # If we added some .moc.cpp files, due to
+				# no other .cpp file including the .moc one.
         
         my @progsources = split(/[\s\034]+/, $sources{$program});
+        my %shash = ();
+        @shash{@progsources} = 1;  # we are only interested in the existence
         my %sourcelist = ();
         
         foreach $source (@progsources) {
@@ -684,7 +688,16 @@ sub tag_FINAL()
             
             $sourcelist{$suffix} .= $source . " ";
         }
-        
+        foreach my $mocFile (keys (%globalmocs))
+        {
+            my ($dir, $hFile, $cppFile) = split ("\035", $globalmocs{$mocFile}, 3);
+            if (defined ($cppFile)) {
+                $mocs .= " $mocFile.moc" if exists $shash{$cppFile};
+            } else {
+		$sourcelist{$cxxsuffix} .= $mocFile . ".moc." . $cxxsuffix;
+		$moc_cpp_added = 1;
+	    }
+        }
         foreach $suffix (keys %sourcelist) {
             
             # See if this file contains c++ code. (i.e., just check the file's suffix against c++ extensions)
@@ -694,8 +707,7 @@ sub tag_FINAL()
               $suffix_is_cxx = 1;
             }
             
-            my $mocfiles_in = ($suffix eq $cxxsuffix) &&
-              defined($depedmocs{$program});
+            my $mocfiles_in = ($suffix eq $cxxsuffix) && $moc_cpp_added;
             
             my @sourcelist = split(/[\s\034]+/, $sourcelist{$suffix});
             
@@ -730,21 +742,11 @@ sub tag_FINAL()
                 }
             }
             
-            if ($mocfiles_in) {
-                $handling .= $depedmocs{$program};
-                foreach $mocfile (split(' ', $depedmocs{$program})) {
-                   
-                    if ($mocfile =~ m/\.$suffix$/) {
-                        $mocsources .= " " . $mocfile;
-                    }
-                }
-            }
-
-            $handling = "$program.all_$suffix.$suffix: \$(srcdir)/Makefile.in" . $source_deps . " " . join(' ', $depedmocs{$program})  . "\n";
+            $handling = "$program.all_$suffix.$suffix: \$(srcdir)/Makefile.in" . $source_deps . " " . join(' ', $mocs)  . "\n";
             $handling .= "\t\@echo 'creating $program.all_$suffix.$suffix ...'; \\\n";
             $handling .= "\trm -f $program.all_$suffix.files $program.all_$suffix.final; \\\n";
             $handling .= "\techo \"#define KDE_USE_FINAL 1\" >> $program.all_$suffix.final; \\\n";
-            $handling .= "\tfor file in " . $sourcelist{$suffix} . "$mocsources; do \\\n";
+            $handling .= "\tfor file in " . $sourcelist{$suffix} . "; do \\\n";
             $handling .= "\t  echo \"#include \\\"\$\$file\\\"\" >> $program.all_$suffix.files; \\\n";
             $handling .= "\t  test ! -f \$\(srcdir\)/\$\$file || egrep '^#pragma +implementation' \$\(srcdir\)/\$\$file >> $program.all_$suffix.final; \\\n";
             $handling .= "\tdone; \\\n";
@@ -828,7 +830,7 @@ sub tag_METASOURCES ()
 
     my $lookup;
     my $found = "";
-
+#print "$program: tag_METASOURCES\n";
     if ($metasourceTags > 1) {
 	$lookup = $program . '_METASOURCES\s*=\s*(.*)';
 	return 1    if ($MakefileData !~ /\n($lookup)\n/);
@@ -1871,9 +1873,7 @@ sub make_meta_classes ()
 	print STDOUT "globalmocs=[".join(' ', keys(%globalmocs))."]\n" if ($verbose);
 	foreach my $mocFile (keys (%globalmocs))
 	{
-	    undef $cppFile;
-	    ($dir, $hFile, $cppFile) = split ("\035", $globalmocs{$mocFile}, 3);
-	    $dir =~ s#^\.#\$(srcdir)#;
+	    my ($dir, $hFile, $cppFile) = split ("\035", $globalmocs{$mocFile}, 3);
 	    if (defined ($cppFile))
 	    {
 		$mocs .= " $mocFile.moc" if exists $shash{$cppFile};
@@ -1939,7 +1939,7 @@ sub updateMakefile ()
     $MakefileData =~ s/\034/\\\n\t/g;    # Restore continuation lines
     # Append our $progId line, _below_ the "generated by automake" line
     # because automake-1.6 relies on the first line to be his own.
-    my $progIdLine = "\# $progId - " . '$Revision$ '."\n";
+    my $progIdLine = "\# $progId - " . '$Revision$ '."\n";
     if ( !( $MakefileData =~ s/^(.*generated .*by automake.*\n)/$1$progIdLine/ ) ) {
         warn "automake line not found in $makefile\n";
 	# Fallback: first line
--- karbon/Makefile.am	2002/06/18 07:37:48	1.41
+++ karbon/Makefile.am	2002/07/05 11:01:39
@@ -13,9 +13,8 @@ SUBDIRS = core shapes widgets dialogs co
 
 bin_PROGRAMS = karbon
 
-lib_LTLIBRARIES = \
-	karbon.la \
-	libkarbonpart.la
+lib_LTLIBRARIES = karbon.la
+kde_module_LTLIBRARIES = libkarbonpart.la
 
 libkarbonpart_la_SOURCES = \
 	karbon_factory.cc \
@@ -40,7 +39,7 @@ libkarbonpart_la_LIBADD = $(LIB_KOFFICEU
 libkarbonpart_la_METASOURCES = AUTO
 
 karbon_la_SOURCES = main.cc
-karbon_la_LDFLAGS = $(all_libraries) -module -avoid-version
+karbon_la_LDFLAGS = $(all_libraries) -module
 karbon_la_LIBADD = libkarbonpart.la
 
 karbon_SOURCES = dummy.cc
--- kchart/Makefile.am	2002/04/17 11:42:35	1.97
+++ kchart/Makefile.am	2002/07/05 11:01:39
@@ -41,7 +41,7 @@ libkchartpart_la_LIBADD = $(top_builddir
 ## The kdeinit loadable module
 lib_LTLIBRARIES = kchart.la
 kchart_la_SOURCES = main.cc
-kchart_la_LDFLAGS = $(all_libraries) -avoid-version -module
+kchart_la_LDFLAGS = $(all_libraries) -module
 kchart_la_LIBADD = $(LIB_KOFFICECORE)
 
 ## The executable
--- kformula/Makefile.am	2002/04/18 19:52:50	1.69
+++ kformula/Makefile.am	2002/07/05 11:01:39
@@ -14,7 +14,7 @@ libkformulapart_la_METASOURCES = AUTO
 ## The kdeinit loadable module
 lib_LTLIBRARIES = kformulamain.la
 kformulamain_la_SOURCES = main.cc
-kformulamain_la_LDFLAGS = $(all_libraries) -module -avoid-version
+kformulamain_la_LDFLAGS = $(all_libraries) -module
 kformulamain_la_LIBADD = $(LIB_KOFFICECORE)
 
 ## The executable
--- kivio/kiviopart/Makefile.am	2002/05/28 08:11:39	1.23
+++ kivio/kiviopart/Makefile.am	2002/07/05 11:01:39
@@ -140,7 +140,7 @@ EXTRA_DIST = \
 #2########################################################!@#$
 lib_LTLIBRARIES = kivio.la
 kivio_la_SOURCES = main.cpp
-kivio_la_LDFLAGS = $(all_libraries) -module -avoid-version
+kivio_la_LDFLAGS = $(all_libraries) -module
 kivio_la_LIBADD = ../../lib/kofficecore/libkofficecore.la
 
 libkiviopart_la_LDFLAGS = -avoid-version -module $(all_libraries)
--- kivio/plugins/kivioconnectortool/Makefile.am	2001/10/05 01:43:16	1.9
+++ kivio/plugins/kivioconnectortool/Makefile.am	2002/07/05 11:01:40
@@ -3,7 +3,7 @@
 #### WARNING! All changes made in this part will be lost! ####
 ##############################################################
 SUBDIRS = straight_connector 
-lib_LTLIBRARIES =libkivioconnectortool.la
+kde_module_LTLIBRARIES =libkivioconnectortool.la
 
 
 INCLUDES = -I$(top_srcdir)/kivio/kiviopart\
@@ -29,7 +29,7 @@ EXTRA_DIST = \
 ##############################################################
 ####                  END KDEStudio part                  ####
 #2########################################################!@#$
-libkivioconnectortool_la_LDFLAGS = -avoid-version -module -no-undefined
+libkivioconnectortool_la_LDFLAGS = -module $(KDE_PLUGIN)
 libkivioconnectortool_la_LIBADD = $(all_libraries) $(top_builddir)/kivio/kiviopart/libkiviopart.la
 
 rc_DATA = kivioconnectortool.rc
--- kivio/plugins/kivioselecttool/Makefile.am	2001/10/05 01:43:16	1.7
+++ kivio/plugins/kivioselecttool/Makefile.am	2002/07/05 11:01:40
@@ -3,7 +3,7 @@
 #### WARNING! All changes made in this part will be lost! ####
 ##############################################################
 SUBDIRS = select_pics 
-lib_LTLIBRARIES =libkivioselecttool.la
+kde_module_LTLIBRARIES =libkivioselecttool.la
 
 
 INCLUDES = -I$(top_srcdir)/kivio/kiviopart\
@@ -25,7 +25,7 @@ EXTRA_DIST = \
 ##############################################################
 ####                  END KDEStudio part                  ####
 #2########################################################!@#$
-libkivioselecttool_la_LDFLAGS = -avoid-version -module -no-undefined
+libkivioselecttool_la_LDFLAGS = -module $(KDE_PLUGIN)
 libkivioselecttool_la_LIBADD = $(all_libraries) $(top_builddir)/kivio/kiviopart/libkiviopart.la
 
 rc_DATA = kivioselecttool.rc
--- kivio/plugins/kiviotexttool/Makefile.am	2001/10/05 01:43:16	1.7
+++ kivio/plugins/kiviotexttool/Makefile.am	2002/07/05 11:01:40
@@ -3,7 +3,7 @@
 #### WARNING! All changes made in this part will be lost! ####
 ##############################################################
 
-lib_LTLIBRARIES =libkiviotexttool.la
+kde_module_LTLIBRARIES =libkiviotexttool.la
 
 
 INCLUDES = -I$(top_srcdir)/kivio/kiviopart\
@@ -29,7 +29,7 @@ EXTRA_DIST = \
 ##############################################################
 ####                  END KDEStudio part                  ####
 #2########################################################!@#$
-libkiviotexttool_la_LDFLAGS = -avoid-version -module -no-undefined
+libkiviotexttool_la_LDFLAGS = -module $(KDE_PLUGIN)
 libkiviotexttool_la_LIBADD = $(all_libraries) $(top_builddir)/kivio/kiviopart/libkiviopart.la
 
 rc_DATA = kiviotexttool.rc
--- kivio/plugins/kiviozoomtool/Makefile.am	2001/10/05 01:43:16	1.8
+++ kivio/plugins/kiviozoomtool/Makefile.am	2002/07/05 11:01:40
@@ -3,7 +3,7 @@
 #### WARNING! All changes made in this part will be lost! ####
 ##############################################################
 SUBDIRS = zoom_pics 
-lib_LTLIBRARIES =libkiviozoomtool.la
+kde_module_LTLIBRARIES =libkiviozoomtool.la
 
 INCLUDES = -I$(top_srcdir)/kivio/kiviopart\
 	-I$(top_srcdir)/kivio/kiviopart/kiviosdk\
@@ -24,7 +24,7 @@ EXTRA_DIST = \
 ##############################################################
 ####                  END KDEStudio part                  ####
 #2########################################################!@#$
-libkiviozoomtool_la_LDFLAGS = -avoid-version -module -no-undefined
+libkiviozoomtool_la_LDFLAGS = -module $(KDE_PLUGIN)
 libkiviozoomtool_la_LIBADD = $(all_libraries) $(top_builddir)/kivio/kiviopart/libkiviopart.la
 
 rc_DATA = kiviozoomtool.rc
--- kontour/Makefile.am	2002/04/07 21:32:50	1.70
+++ kontour/Makefile.am	2002/07/05 11:01:40
@@ -14,7 +14,7 @@ rc_DATA = kontour.rc
 ## The kdeinit loadable module
 lib_LTLIBRARIES = kontour.la
 kontour_la_SOURCES = main.cc
-kontour_la_LDFLAGS = $(all_libraries) -avoid-version -module
+kontour_la_LDFLAGS = $(all_libraries) -module
 kontour_la_LIBADD = ../lib/kofficecore/libkofficecore.la
 
 ## The executable
--- koshell/Makefile.am	2001/03/22 14:02:17	1.25
+++ koshell/Makefile.am	2002/07/05 11:01:40
@@ -4,7 +4,7 @@ INCLUDES  = $(KOFFICE_INCLUDES) $(all_in
 ## The kdeinit loadable module
 lib_LTLIBRARIES = koshell.la
 koshell_la_SOURCES = koshell_main.cc koshell_shell.cc
-koshell_la_LDFLAGS = $(all_libraries) -avoid-version -module
+koshell_la_LDFLAGS = $(all_libraries) -module
 koshell_la_LIBADD = $(LIB_KOFFICEUI)
 
 ## The executable
--- kpresenter/Makefile.am	2002/06/10 11:11:45	1.198
+++ kpresenter/Makefile.am	2002/07/05 11:01:40
@@ -55,7 +55,7 @@ libkpresenterpart_la_METASOURCES = AUTO
 ## The kdeinit loadable module
 lib_LTLIBRARIES = kpresenter.la
 kpresenter_la_SOURCES = main.cc
-kpresenter_la_LDFLAGS = $(all_libraries) -avoid-version -module
+kpresenter_la_LDFLAGS = $(all_libraries) -module
 kpresenter_la_LIBADD = $(LIB_KOFFICECORE)
 
 ## The executable
--- kspread/Makefile.am	2002/06/09 01:26:37	1.173
+++ kspread/Makefile.am	2002/07/05 11:01:40
@@ -49,7 +49,7 @@ libkspreadpart_la_METASOURCES = AUTO
 ## The kdeinit loadable module
 lib_LTLIBRARIES =  kspread.la
 kspread_la_SOURCES = main.cc
-kspread_la_LDFLAGS = $(all_libraries) -avoid-version -module
+kspread_la_LDFLAGS = $(all_libraries) -module
 kspread_la_LIBADD = $(LIB_KOFFICECORE)
 
 ## The executable
--- kugar/part/Makefile.am	2002/02/27 13:41:41	1.5
+++ kugar/part/Makefile.am	2002/07/05 11:01:44
@@ -2,7 +2,7 @@ INCLUDES = -I$(srcdir)/../lib $(KOFFICE_
 
 lib_LTLIBRARIES = libkugarpart.la
 libkugarpart_la_SOURCES = kugar_part.cpp
-libkugarpart_la_LDFLAGS = $(all_libraries) -module -avoid-version
+libkugarpart_la_LDFLAGS = $(all_libraries) -module
 libkugarpart_la_LIBADD = ../lib/libkugar.la $(LIB_KPARTS) $(LIB_KDEPRINT)
 
 libkugarpart_la_METASOURCES = AUTO
--- kword/Makefile.am	2002/06/14 09:56:35	1.186
+++ kword/Makefile.am	2002/07/05 11:01:44
@@ -56,7 +56,7 @@ kwmailmerge_servicetypedir=$(kde_service
 
 ## The kdeinit loadable module
 kword_la_SOURCES = main.cc
-kword_la_LDFLAGS = $(all_libraries) -avoid-version -module
+kword_la_LDFLAGS = $(all_libraries) -module
 kword_la_LIBADD = ../lib/kofficecore/libkofficecore.la
 
 ## The executable
